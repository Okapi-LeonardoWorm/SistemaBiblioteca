{% extends 'base.html' %}
{% from 'bootstrap5/pagination.html' import render_pagination %}

{% block title %}Gerenciar Empréstimos{% endblock %}

{% block head_links %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/management.css') }}">
{% endblock %}

{% block content %}
<div class="container py-4">
    <header class="management-header">
        <h1 class="h3">Gerenciar Empréstimos</h1>
        <form class="search-form" method="GET" action="{{ url_for('main.emprestimos') }}">
            <input type="text" name="search" class="form-control" placeholder="Buscar por livro ou usuário..." value="{{ search_term or '' }}">
            <button type="submit" class="btn btn-primary">Buscar</button>
        </form>
    </header>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#loanModal" data-loan-id="">
            <i class="fas fa-plus"></i> Novo Empréstimo
        </button>
        
        <form method="GET" action="{{ url_for('main.emprestimos') }}" class="d-flex align-items-center">
            <input type="hidden" name="search" value="{{ search_term or '' }}">
            <label for="per_page" class="form-label me-2 mb-0">Itens:</label>
            <select name="per_page" id="per_page" class="form-select form-select-sm" style="width: auto;" onchange="this.form.submit()">
                <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
                <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
            </select>
        </form>
    </div>

    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Livro</th>
                    <th>Usuário</th>
                    <th>Data Empréstimo</th>
                    <th>Data Devolução</th>
                    <th>Status</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for loan in loans.items %}
                <tr data-bs-toggle="modal" data-bs-target="#loanModal" data-loan-id="{{ loan.loanId }}">
                    <td>{{ loan.book.bookName }}</td>
                    <td>{{ loan.user.username }}</td>
                    <td>{{ loan.loanDate.strftime('%d/%m/%Y') }}</td>
                    <td>{{ loan.returnDate.strftime('%d/%m/%Y') }}</td>
                    <td><span class="badge bg-{% if loan.status.name == 'ACTIVE' %}success{% elif loan.status.name == 'OVERDUE' %}danger{% else %}secondary{% endif %}">{{ loan.status.value }}</span></td>
                    <td>
                        {% if loan.status.name in ['ACTIVE', 'OVERDUE'] %}
                        <button type="button"
                                class="btn btn-sm btn-warning btn-return-loan mb-1"
                                data-loan-id="{{ loan.loanId }}"
                                data-loan-return-date="{{ loan.returnDate.isoformat() }}"
                                onclick="event.stopPropagation();"
                                title="Informar retorno">
                            <i class="fas fa-undo"></i> Retornar
                        </button>
                        {% endif %}
                        <form action="{{ url_for('main.excluir_emprestimo', id=loan.loanId) }}" method="POST" onsubmit="event.stopPropagation(); return confirm('Tem certeza que deseja excluir este empréstimo?');" onclick="event.stopPropagation();">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i> Excluir</button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center">Nenhum empréstimo encontrado.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="mt-3">
        {{ render_pagination(loans, search=search_term, per_page=per_page) }}
    </div>

    <!-- Loan Modal -->
    <div class="modal fade" id="loanModal" tabindex="-1" aria-labelledby="loanModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loanModalLabel">Carregando...</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Form will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveLoanBtn">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Return Loan Modal -->
    <div class="modal fade" id="loanReturnModal" tabindex="-1" aria-labelledby="loanReturnModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loanReturnModalLabel">Informar retorno do empréstimo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="loanReturnForm">
                    <div class="modal-body">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" id="returnLoanId" name="loanId">

                        <div class="mb-3">
                            <label for="returnDateInput" class="form-label">Data de retorno</label>
                            <input type="date" class="form-control" id="returnDateInput" name="returnDate" required>
                        </div>

                        <div class="mb-3">
                            <label for="returnStatusInput" class="form-label">Situação do empréstimo</label>
                            <select class="form-select" id="returnStatusInput" name="status" required>
                                <option value="COMPLETED">Concluído</option>
                                <option value="LOST">Livro Perdido</option>
                            </select>
                        </div>

                        <div class="alert alert-danger d-none" id="loanReturnError"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success">Confirmar retorno</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const loanModal = document.getElementById('loanModal');
    const saveLoanBtn = document.getElementById('saveLoanBtn');
    const loanReturnModalEl = document.getElementById('loanReturnModal');
    const loanReturnForm = document.getElementById('loanReturnForm');
    const loanReturnError = document.getElementById('loanReturnError');

    loanModal.addEventListener('show.bs.modal', function (event) {
        const trigger = event.relatedTarget;
        const loanId = trigger.getAttribute('data-loan-id');
        const modalTitle = loanModal.querySelector('.modal-title');
        const modalBody = loanModal.querySelector('.modal-body');
        
        modalTitle.textContent = 'Carregando...';
        modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';

        const formUrl = loanId ? `/emprestimos/form/${loanId}` : '/emprestimos/form';

        fetch(formUrl)
            .then(response => response.text())
            .then(html => {
                modalTitle.textContent = loanId ? 'Editar Empréstimo' : 'Novo Empréstimo';
                modalBody.innerHTML = html;
                // Após injetar o HTML do formulário, inicializar autocomplete/busca
                (function initLoanSearch() {
                    const userSearch = modalBody.querySelector('#userSearch');
                    const userSug = modalBody.querySelector('#userSuggestions');
                    const userInfo = modalBody.querySelector('#selectedUserInfo');
                    const hiddenUserId = modalBody.querySelector('#selectedUserId');

                    const bookSearch = modalBody.querySelector('#bookSearch');
                    const bookSug = modalBody.querySelector('#bookSuggestions');
                    const bookInfo = modalBody.querySelector('#selectedBookInfo');
                    const hiddenBookId = modalBody.querySelector('#selectedBookId');

                    const loanDate = modalBody.querySelector('input[name="loanDate"]');
                    const returnDate = modalBody.querySelector('input[name="returnDate"]');

                    function setInfo(container, data) {
                        if (!container) return;
                        container.style.display = '';
                        for (const [k, v] of Object.entries(data)) {
                            const el = container.querySelector(`[data-field="${k}"]`);
                            if (el) el.textContent = Array.isArray(v) ? v.join(', ') : (v ?? '');
                        }
                    }

                    async function fetchJSON(url) {
                        const r = await fetch(url);
                        if (!r.ok) throw new Error('Erro ao buscar dados');
                        return await r.json();
                    }

                    async function searchUsers(q) {
                        if (!q || q.length < 2) { if (userSug) userSug.innerHTML = ''; return; }
                        const data = await fetchJSON(`/api/users/search?q=${encodeURIComponent(q)}&limit=8`);
                        if (!userSug) return;
                        userSug.innerHTML = '';
                        (data.results || []).forEach(u => {
                            const a = document.createElement('a');
                            a.href = '#'; a.className = 'list-group-item list-group-item-action';
                            a.textContent = `${u.identificationCode || ''} - ${u.name || ''}`.trim();
                            a.addEventListener('click', (e) => {
                                e.preventDefault();
                                if (hiddenUserId) hiddenUserId.value = u.userId;
                                setInfo(userInfo, u);
                                userSug.innerHTML = '';
                                if (userSearch) userSearch.value = `${u.identificationCode || ''} - ${u.name || ''}`.trim();
                            });
                            userSug.appendChild(a);
                        });
                    }

                    async function searchBooks(q) {
                        if (!q || q.length < 2) { if (bookSug) bookSug.innerHTML = ''; return; }
                        const params = new URLSearchParams({ q, limit: '8' });
                        if (loanDate?.value) params.append('loanDate', loanDate.value);
                        if (returnDate?.value) params.append('returnDate', returnDate.value);
                        const data = await fetchJSON(`/api/books/search?${params.toString()}`);
                        if (!bookSug) return;
                        bookSug.innerHTML = '';
                        (data.results || []).forEach(b => {
                            const a = document.createElement('a');
                            a.href = '#'; a.className = 'list-group-item list-group-item-action';
                            a.textContent = `${b.bookName} — ${b.authorName || ''}`.trim();
                            a.addEventListener('click', (e) => {
                                e.preventDefault();
                                if (hiddenBookId) hiddenBookId.value = b.bookId;
                                setInfo(bookInfo, b);
                                bookSug.innerHTML = '';
                                if (bookSearch) bookSearch.value = `${b.bookName}`;
                            });
                            bookSug.appendChild(a);
                        });
                    }

                    userSearch?.addEventListener('input', (e) => searchUsers(e.target.value));
                    bookSearch?.addEventListener('input', (e) => searchBooks(e.target.value));
                    loanDate?.addEventListener('change', () => bookSearch?.value && searchBooks(bookSearch.value));
                    returnDate?.addEventListener('change', () => bookSearch?.value && searchBooks(bookSearch.value));
                })();
            })
            .catch(err => {
                modalBody.innerHTML = '<p class="text-danger">Erro ao carregar o formulário.</p>';
            });
    });

    saveLoanBtn.addEventListener('click', function() {
        const form = document.getElementById('loanModalForm');
        if (form) {
            const formData = new FormData(form);
            const actionUrl = form.getAttribute('action');
            // valida seleção via autocomplete
            const uid = form.querySelector('#selectedUserId');
            const bid = form.querySelector('#selectedBookId');
            if (uid && !uid.value) {
                alert('Selecione um usuário válido.');
                return;
            }
            if (bid && !bid.value) {
                alert('Selecione um livro válido.');
                return;
            }

            fetch(actionUrl, {
                method: 'POST',
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Erro de validação: ' + JSON.stringify(data.errors));
                }
            })
            .catch(err => {
                alert('Ocorreu um erro ao salvar.');
            });
        }
    });

    // Impede que clicar nas ações abra o modal de edição da linha
    document.querySelectorAll('td form, .btn-return-loan').forEach((el) => {
        el.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    });

    // Abrir modal de retorno
    document.querySelectorAll('.btn-return-loan').forEach((btn) => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const loanId = btn.getAttribute('data-loan-id');
            const previousReturnDate = btn.getAttribute('data-loan-return-date');
            document.getElementById('returnLoanId').value = loanId || '';
            // padrão: hoje
            document.getElementById('returnDateInput').valueAsDate = new Date();
            // fallback para data previamente cadastrada
            if (!document.getElementById('returnDateInput').value && previousReturnDate) {
                document.getElementById('returnDateInput').value = previousReturnDate;
            }
            document.getElementById('returnStatusInput').value = 'COMPLETED';
            loanReturnError.classList.add('d-none');
            loanReturnError.textContent = '';

            const returnModal = new bootstrap.Modal(loanReturnModalEl);
            returnModal.show();
        });
    });

    // Submeter retorno
    loanReturnForm?.addEventListener('submit', async function(e) {
        e.preventDefault();
        loanReturnError.classList.add('d-none');
        loanReturnError.textContent = '';

        const loanId = document.getElementById('returnLoanId').value;
        const formData = new FormData(loanReturnForm);

        try {
            const resp = await fetch(`/emprestimos/return/${loanId}`, {
                method: 'POST',
                body: formData,
            });
            const data = await resp.json();

            if (!resp.ok || !data.success) {
                const msg = data?.errors ? JSON.stringify(data.errors) : 'Erro ao registrar retorno.';
                loanReturnError.textContent = msg;
                loanReturnError.classList.remove('d-none');
                return;
            }

            window.location.reload();
        } catch (err) {
            loanReturnError.textContent = 'Falha de comunicação ao registrar retorno.';
            loanReturnError.classList.remove('d-none');
        }
    });
});
</script>
{% endblock %}
