<form id="userModalForm" action="{{ url_for('main.new_user') if not user_id else url_for('main.edit_user', user_id=user_id) }}" method="POST">
    {{ form.hidden_tag() }}
    <div class="mb-3">
        <label class="form-label">{{ form.userType.label.text }} <span style="color:#d00">*</span></label>
        {{ form.userType(class="form-select", id="userTypeSelect", required=True) }}
    </div>
    <div class="mb-3">
        <label class="form-label">{{ form.identificationCode.label.text }} <span style="color:#d00">*</span></label>
        {{ form.identificationCode(class="form-control", id="identificationCodeInput", required=True, minlength=3, maxlength=150) }}
        <div id="identificationCodeHelp" class="form-text"></div>
    </div>
    <div class="mb-3">
        <label class="form-label">{{ form.userCompleteName.label.text }} <span style="color:#d00">*</span></label>
        {{ form.userCompleteName(class="form-control", required=True, minlength=3, maxlength=100) }}
    </div>
    <div class="mb-3">
        {{ form.password.label(class="form-label") }}
        {{ form.password(class="form-control", placeholder="Deixe em branco para não alterar") }}
    </div>
    <div class="mb-3">
        {{ form.userPhone.label(class="form-label") }}
        {{ form.userPhone(class="form-control", id="userPhoneInput", placeholder="(11) 91234-5678", inputmode="numeric") }}
    </div>
    <div class="mb-3">
        <label class="form-label">{{ form.birthDate.label.text }} <span id="birthDateRequiredMark" style="color:#d00; display:none">*</span></label>
        {{ form.birthDate(class="form-control", type="date", id="birthDateInput") }}
    </div>
    <div class="mb-3">
        {{ form.cpf.label(class="form-label") }}
        {{ form.cpf(class="form-control", id="cpfInput", placeholder="000.000.000-00", inputmode="numeric") }}
    </div>
    <div class="mb-3">
        {{ form.rg.label(class="form-label") }}
        {{ form.rg(class="form-control", id="rgInput", placeholder="00.000.000-0", inputmode="numeric") }}
    </div>
    <div class="mb-3">
        {{ form.gradeNumber.label(class="form-label") }}
        {{ form.gradeNumber(class="form-control") }}
    </div>
    <div class="mb-3">
        {{ form.className.label(class="form-label") }}
        {{ form.className(class="form-control") }}
    </div>
    <div class="mb-3">
        {{ form.guardianName1.label(class="form-label") }}
        {{ form.guardianName1(class="form-control") }}
    </div>
    <div class="mb-3">
        {{ form.guardianPhone1.label(class="form-label") }}
        {{ form.guardianPhone1(class="form-control", id="guardianPhone1Input", placeholder="(11) 4002-8922", inputmode="numeric") }}
    </div>
    <div class="mb-3">
        {{ form.guardianName2.label(class="form-label") }}
        {{ form.guardianName2(class="form-control") }}
    </div>
    <div class="mb-3">
        {{ form.guardianPhone2.label(class="form-label") }}
        {{ form.guardianPhone2(class="form-control", id="guardianPhone2Input", placeholder="(11) 4002-8922", inputmode="numeric") }}
    </div>
    <div class="mb-3">
        {{ form.notes.label(class="form-label") }}
        {{ form.notes(class="form-control") }}
    </div>
    <script>
    (function() {
        function onlyDigits(s) { return (s||'').replace(/\D+/g, ''); }
        function maskPhone(v) {
            const d = onlyDigits(v).slice(0, 11);
            if (d.length <= 10) {
                // (DD) 1234-5678
                return d.replace(/(\d{0,2})(\d{0,4})(\d{0,4})/, function(_, a,b,c){
                    let out = '';
                    if (a) out += '('+a;
                    if (a && a.length===2) out += ') ';
                    if (b) out += b;
                    if (c) out += '-' + c;
                    return out;
                });
            }
            // 11 dígitos: (DD) 9XXXX-XXXX
            return d.replace(/(\d{0,2})(\d{0,5})(\d{0,4})/, function(_, a,b,c){
                let out = '';
                if (a) out += '('+a;
                if (a && a.length===2) out += ') ';
                if (b) out += b;
                if (c) out += '-' + c;
                return out;
            });
        }
        function maskCPF(v) {
            const d = onlyDigits(v).slice(0, 11);
            return d.replace(/(\d{0,3})(\d{0,3})(\d{0,3})(\d{0,2})/, function(_, a,b,c,d){
                let out = '';
                if (a) out += a;
                if (b) out += (a?'.':'') + b;
                if (c) out += (b?'.':'') + c;
                if (d) out += (c?'-':'') + d;
                return out;
            });
        }
        function maskRG(v) {
            const d = onlyDigits(v).slice(0, 14);
            // Formato livre, mas vamos aplicar pontuação típica 9-10 dígitos: 00.000.000-0
            if (d.length <= 9) {
                return d.replace(/(\d{0,2})(\d{0,3})(\d{0,3})(\d{0,1})/, function(_, a,b,c,d){
                    let out='';
                    if (a) out += a;
                    if (b) out += (a?'.':'') + b;
                    if (c) out += (b?'.':'') + c;
                    if (d) out += (c?'-':'') + d;
                    return out;
                });
            }
            return d; // para comprimentos maiores, manter só dígitos ou extensão simples
        }

        function attachMask(el, masker) {
            if (!el) return;
            el.addEventListener('input', () => {
                const start = el.selectionStart;
                const end = el.selectionEnd;
                el.value = masker(el.value);
                try { el.setSelectionRange(start, end); } catch(e) {}
            });
            // mascarar valor inicial, se houver
            el.value = masker(el.value);
        }

        attachMask(document.getElementById('userPhoneInput'), maskPhone);
        attachMask(document.getElementById('guardianPhone1Input'), maskPhone);
        attachMask(document.getElementById('guardianPhone2Input'), maskPhone);
        attachMask(document.getElementById('cpfInput'), maskCPF);
        attachMask(document.getElementById('rgInput'), maskRG);
        const input = document.getElementById('identificationCodeInput');
        const help = document.getElementById('identificationCodeHelp');
        if (input) {
            input.addEventListener('change', async () => {
                const val = input.value.trim();
                if (!val) { return; }
                try {
                    const resp = await fetch(`{{ url_for('main.check_identification_code') }}?code=${encodeURIComponent(val)}`);
                    const data = await resp.json();
                    if (data.exists) {
                        input.classList.add('is-invalid');
                        input.style.color = '#7a0000';
                        help.textContent = 'Código já existente. Escolha outro.';
                        help.style.color = '#7a0000';
                    } else {
                        input.classList.remove('is-invalid');
                        input.style.color = '';
                        help.textContent = '';
                    }
                } catch (e) {
                    // silencioso
                }
            });
        }
        const userType = document.getElementById('userTypeSelect');
        const studentFields = ['gradeNumber','className','guardianName1','guardianPhone1','guardianName2','guardianPhone2'];
        const allStudentEls = studentFields.map(name => document.getElementById(`userModalForm`).querySelector(`[name="${name}"]`)?.closest('.mb-3')).filter(Boolean);
        function updateVisibility() {
            const t = userType?.value;
            const showStudent = (t === 'aluno');
            allStudentEls.forEach(el => el.style.display = showStudent ? '' : 'none');
        }
        if (userType) {
            userType.addEventListener('change', updateVisibility);
            updateVisibility();
        }

        // birthDate obrigatório apenas na criação
        const birthDate = document.getElementById('birthDateInput');
        const birthMark = document.getElementById('birthDateRequiredMark');
        const isEdit = {{ 'true' if user_id else 'false' }};
        function setBirthDateRequirement() {
            if (!isEdit) {
                birthMark.style.display = '';
                birthDate?.setAttribute('required', 'required');
            } else {
                birthMark.style.display = 'none';
                birthDate?.removeAttribute('required');
            }
        }
        setBirthDateRequirement();

        // Validação básica antes de enviar
        const formEl = document.getElementById('userModalForm');
        formEl?.addEventListener('submit', (e) => {
            // Se for criação, garantir birthDate preenchido
            if (!isEdit) {
                if (birthDate && !birthDate.value) {
                    e.preventDefault();
                    birthDate.classList.add('is-invalid');
                    alert('Preencha a Data de Nascimento.');
                    return false;
                }
            }
            return true;
        });
    })();
    </script>
</form>
