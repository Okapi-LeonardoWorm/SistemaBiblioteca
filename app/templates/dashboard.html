{% extends 'base.html' %}
{% from 'bootstrap5/pagination.html' import render_pagination %}

{% block title %}
  Dashboard Administrativo
{% endblock %}

{% block head_links %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
{% endblock %}

{% block content %}
  <div class="container-fluid py-4">
    <!-- Header -->
    <header class="dashboard-header mb-4">
      <h2>Dashboard Administrativo</h2>
    </header>

    <div class="row">
      <!-- Loan List -->
      <div class="col-lg-8">
        <h3 class="section-title">Empréstimos com Devolução Próxima</h3>
        <div class="filter-buttons btn-group mb-3">
          <a href="{{ url_for('main.dashboard', filter='today') }}" class="btn btn-outline-primary {% if loan_filter == 'today' %}active{% endif %}">Hoje</a>
          <a href="{{ url_for('main.dashboard', filter='week') }}" class="btn btn-outline-primary {% if loan_filter == 'week' %}active{% endif %}">Esta Semana</a>
          <a href="{{ url_for('main.dashboard', filter='all') }}" class="btn btn-outline-primary {% if loan_filter == 'all' %}active{% endif %}">Todos</a>
          <a href="{{ url_for('main.dashboard', filter='overdue') }}" class="btn btn-outline-danger position-relative {% if loan_filter == 'overdue' %}active{% endif %}">
            Atrasados{% if overdue_loans_count > 0 %}
              <span class="overdue-badge">{{ overdue_loans_count }}</span>
            {% endif %}
          </a>
        </div>

        <div class="loan-list-card">
          <div class="list-group loan-list-group">
            {% for loan in loans.items %}
              <a href="#" class="list-group-item list-group-item-action loan-list-item" data-bs-toggle="modal" data-bs-target="#loanDetailsModal" data-loan-id="{{ loan.loanId }}" data-book-name="{{ loan.book.bookName }}" data-user-name="{{ loan.user.userCompleteName or loan.user.username }}" data-user-code="{{ loan.user.username }}" data-loan-date="{{ loan.loanDate.isoformat() }}" data-return-date="{{ loan.returnDate.isoformat() }}" data-amount="{{ loan.amount }}" data-status="{{ loan.status.name }}">
                <div class="loan-list-top">
                  <span class="loan-label">Livro</span>
                  <span class="loan-date-badge">Devolução: {{ loan.returnDate.strftime('%d/%m/%Y') }}</span>
                </div>
                <div class="loan-book-name">{{ loan.book.bookName }}</div>
                <div class="loan-user-line">
                  <strong>Usuário:</strong> {{ loan.user.username }}
                </div>
              </a>
            {% else %}
              <div class="list-group-item loan-empty-item">Nenhum empréstimo encontrado para este filtro.</div>
            {% endfor %}
          </div>
        </div>

        <!-- Pagination for loans -->
        <div class="mt-3">{{ render_pagination(loans) }}</div>
      </div>

      <!-- Recently Loaned Books -->
      <div class="col-lg-4">
        <h3 class="section-title">Últimos Livros Retirados</h3>
        <div class="recent-books-card">
          <div class="list-group recent-books-list">
            {% for info in recent_books %}
              <div class="list-group-item recent-books-item">
                <div class="recent-books-name">{{ info.book.bookName }}</div>
                <span class="badge bg-secondary recent-books-badge">Retirados: {{ info.amount }}</span>
              </div>
            {% else %}
              <div class="list-group-item recent-books-empty">Nenhum livro emprestado recentemente.</div>
            {% endfor %}
          </div>
        </div>
        <!-- Pagination for recent books -->
        <div class="mt-3">{{ render_pagination(recent_books_pagination, page_parameter='recent_books_page') }}</div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="row mt-4">
      <div class="col-md-3 col-sm-6">
        <div class="kpi-card">
          <div class="kpi-value">{{ total_books }}</div>
          <div class="kpi-label">Livros na Biblioteca</div>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="kpi-card">
          <div class="kpi-value">{{ total_loans_active }}</div>
          <div class="kpi-label">Livros Emprestados</div>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="kpi-card">
          <div class="kpi-value">{{ total_students }}</div>
          <div class="kpi-label">Alunos Cadastrados</div>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="kpi-card">
          <div class="kpi-value">{{ total_staff }}</div>
          <div class="kpi-label">Colaboradores</div>
        </div>
      </div>
    </div>

    <div class="row mt-4">
      <div class="col-md-6">
        <div class="keyword-analytics-card">
          <h3 class="section-title mb-3">Top 10 palavras-chave mais utilizadas</h3>

          {% if keyword_top10 %}
            <div class="table-responsive keyword-top-scroll">
              <table class="table table-sm table-striped keyword-top-table mb-0">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Palavra-chave</th>
                    <th>Ocorrências</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in keyword_top10 %}
                    <tr>
                      <td>{{ loop.index }}</td>
                      <td>{{ item.word }}</td>
                      <td>{{ item.count }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="alert alert-secondary mb-0">Ainda não há palavras-chave vinculadas a livros.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Modal: detalhes do empréstimo -->
    <div class="modal fade" id="loanDetailsModal" tabindex="-1" aria-labelledby="loanDetailsModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="loanDetailsModalLabel">Detalhes do Empréstimo</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>
              <strong>Livro:</strong> <span id="detailBookName"></span>
            </p>
            <p>
              <strong>Usuário:</strong> <span id="detailUserName"></span> (<span id="detailUserCode"></span>)
            </p>
            <p>
              <strong>Quantidade:</strong> <span id="detailAmount"></span>
            </p>
            <p>
              <strong>Data Empréstimo:</strong> <span id="detailLoanDate"></span>
            </p>
            <p>
              <strong>Data Prevista Retorno:</strong> <span id="detailReturnDate"></span>
            </p>
            <p>
              <strong>Status:</strong> <span id="detailStatus"></span>
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            <button type="button" class="btn btn-primary" id="openReturnModalBtn">Informar retorno</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: informar retorno -->
    <div class="modal fade" id="loanReturnModal" tabindex="-1" aria-labelledby="loanReturnModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="loanReturnModalLabel">Informar Retorno</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="loanReturnForm">
            <div class="modal-body">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
              <input type="hidden" id="returnLoanId" name="loanId" />

              <div class="mb-3">
                <label for="returnDateInput" class="form-label">Data de retorno</label>
                <input type="date" class="form-control" id="returnDateInput" name="returnDate" required />
              </div>

              <div class="mb-3">
                <label for="returnStatusInput" class="form-label">Situação do empréstimo</label>
                <select class="form-select" id="returnStatusInput" name="status" required>
                  <option value="COMPLETED">Concluído</option>
                  <option value="LOST">Livro Perdido</option>
                </select>
              </div>

              <div class="alert alert-danger d-none" id="loanReturnError"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-success">Confirmar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const detailsModalEl = document.getElementById('loanDetailsModal')
      const returnModalEl = document.getElementById('loanReturnModal')
      const openReturnBtn = document.getElementById('openReturnModalBtn')
      const returnForm = document.getElementById('loanReturnForm')
      const returnError = document.getElementById('loanReturnError')
    
      function formatDateBR(isoDate) {
        if (!isoDate) return ''
        const [y, m, d] = isoDate.split('-')
        if (!y || !m || !d) return isoDate
        return `${d}/${m}/${y}`
      }
    
      function statusLabel(status) {
        if (status === 'ACTIVE') return 'Ativo'
        if (status === 'OVERDUE') return 'Atrasado'
        if (status === 'COMPLETED') return 'Concluído'
        if (status === 'LOST') return 'Perdido'
        return status || ''
      }
    
      detailsModalEl?.addEventListener('show.bs.modal', function (event) {
        const trigger = event.relatedTarget
        if (!trigger) return
    
        const data = trigger.dataset
        document.getElementById('detailBookName').textContent = data.bookName || ''
        document.getElementById('detailUserName').textContent = data.userName || ''
        document.getElementById('detailUserCode').textContent = data.userCode || ''
        document.getElementById('detailAmount').textContent = data.amount || ''
        document.getElementById('detailLoanDate').textContent = formatDateBR(data.loanDate)
        document.getElementById('detailReturnDate').textContent = formatDateBR(data.returnDate)
        document.getElementById('detailStatus').textContent = statusLabel(data.status)
    
        openReturnBtn.dataset.loanId = data.loanId || ''
      })
    
      openReturnBtn?.addEventListener('click', function () {
        const loanId = openReturnBtn.dataset.loanId
        document.getElementById('returnLoanId').value = loanId || ''
        document.getElementById('returnDateInput').valueAsDate = new Date()
        document.getElementById('returnStatusInput').value = 'COMPLETED'
    
        const detailsModal = bootstrap.Modal.getInstance(detailsModalEl)
        detailsModal?.hide()
    
        const returnModal = new bootstrap.Modal(returnModalEl)
        returnModal.show()
      })
    
      returnForm?.addEventListener('submit', async function (e) {
        e.preventDefault()
        returnError.classList.add('d-none')
        returnError.textContent = ''
    
        const loanId = document.getElementById('returnLoanId').value
        const formData = new FormData(returnForm)
    
        try {
          const resp = await fetch(`/emprestimos/return/${loanId}`, {
            method: 'POST',
            body: formData
          })
          const data = await resp.json()
    
          if (!resp.ok || !data.success) {
            const msg = data?.errors ? JSON.stringify(data.errors) : 'Erro ao registrar retorno.'
            returnError.textContent = msg
            returnError.classList.remove('d-none')
            return
          }
    
          window.location.reload()
        } catch (err) {
          returnError.textContent = 'Falha de comunicação ao registrar retorno.'
          returnError.classList.remove('d-none')
        }
      })
    })
  </script>
{% endblock %}
