{% extends 'base.html' %}
{% from 'bootstrap5/pagination.html' import render_pagination %}

{% block title %}
  Dashboard Administrativo
{% endblock %}

{% block head_links %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
{% endblock %}

{% block content %}
  <div class="container-fluid py-4">
    <!-- Header -->
    <header class="dashboard-header mb-4">
      <h2>Dashboard Administrativo</h2>
    </header>

    <!-- KPIs -->
    <div class="row">
      <div class="col-md-3 col-sm-6">
        <div class="kpi-card">
          <div class="kpi-value">{{ total_books }}</div>
          <div class="kpi-label">Livros na Biblioteca</div>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="kpi-card">
          <div class="kpi-value">{{ total_loans_active }}</div>
          <div class="kpi-label">Livros Emprestados</div>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="kpi-card">
          <div class="kpi-value">{{ total_students }}</div>
          <div class="kpi-label">Alunos Cadastrados</div>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="kpi-card">
          <div class="kpi-value">{{ total_staff }}</div>
          <div class="kpi-label">Funcionários</div>
        </div>
      </div>
    </div>

    <div class="row">
      <!-- Loan List -->
      <div class="col-lg-8">
        <h3 class="section-title">Empréstimos com Devolução Próxima</h3>
        <div class="filter-buttons btn-group mb-3">
          <a href="{{ url_for('main.dashboard', filter='today') }}" class="btn btn-outline-primary {% if loan_filter == 'today' %}active{% endif %}">Hoje</a>
          <a href="{{ url_for('main.dashboard', filter='week') }}" class="btn btn-outline-primary {% if loan_filter == 'week' %}active{% endif %}">Esta Semana</a>
          <a href="{{ url_for('main.dashboard', filter='all') }}" class="btn btn-outline-primary {% if loan_filter == 'all' %}active{% endif %}">Todos</a>
          <a href="{{ url_for('main.dashboard', filter='overdue') }}" class="btn btn-outline-danger position-relative {% if loan_filter == 'overdue' %}active{% endif %}">
            Atrasados{% if overdue_loans_count > 0 %}
              <span class="overdue-badge">{{ overdue_loans_count }}</span>
            {% endif %}
          </a>
        </div>

        <div class="list-group">
          {% for loan in loans.items %}
            <a href="/emprestimos/form/{{ loan.loanId }}" class="list-group-item list-group-item-action" data-bs-toggle="modal" data-bs-target="#loanModal" data-loan-id="{{ loan.loanId }}"><strong>Livro:</strong> {{ loan.book.bookName }} | <strong>Usuário:</strong> {{ loan.user.username }} | <strong>Devolução:</strong> {{ loan.returnDate.strftime('%d/%m/%Y') }}</a>
          {% else %}
            <div class="list-group-item">Nenhum empréstimo encontrado para este filtro.</div>
          {% endfor %}
        </div>

        <!-- Pagination for loans -->
        <div class="mt-3">{{ render_pagination(loans) }}</div>
      </div>

      <!-- Recently Loaned Books -->
      <div class="col-lg-4">
        <h3 class="section-title">Últimos Livros Emprestados</h3>
        <div class="list-group">
          {% for info in recent_books %}
            <div class="list-group-item">
              {{ info.book.bookName }}
              <span class="badge bg-secondary float-end">Disponíveis: {{ info.available }}</span>
            </div>
          {% else %}
            <div class="list-group-item">Nenhum livro emprestado recentemente.</div>
          {% endfor %}
        </div>
        <!-- Pagination for recent books -->
        <div class="mt-3">{{ render_pagination(recent_books_pagination, page_parameter='recent_books_page') }}</div>
      </div>
    </div>
  </div>
{% endblock %}
