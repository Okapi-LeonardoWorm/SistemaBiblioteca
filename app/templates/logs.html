{% extends 'base.html' %}

{% block title %}
  Logs de Auditoria
{% endblock %}

{% block head_links %}
  <style>
    .changes-json {
      font-family: monospace;
      white-space: pre-wrap;
      font-size: 0.9em;
      max-height: 200px;
      overflow-y: auto;
    }
    .table-responsive {
      margin-top: 20px;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="container mt-4">
    <h1>System Logs</h1>

    <div class="table-responsive">
      <table class="table table-striped table-hover table-bordered">
        <thead class="table-dark">
          <tr>
            <th>Timestamp</th>
            <th>User ID</th>
            <th>User Code</th>
            <th>Action</th>
            <th>Target Type</th>
            <th>Target ID</th>
            <th>Changes</th>
          </tr>
        </thead>
        <tbody>
          {% for log, user_code in pagination.items %}
            <tr>
              <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
              <td>
                {% if log.user_id %}
                  {{ log.user_id }}
                {% else %}
                  System
                {% endif %}
              </td>
              <td>
                {% if user_code %}
                  {{ user_code }}
                {% else %}
                  {% if log.user_id %}
                    Unknown
                  {% else %}
                    System
                  {% endif %}
                {% endif %}
              </td>
              <td>
                <span class="badge bg-secondary">{{ log.action }}</span>
              </td>
              <td>{{ log.target_type }}</td>
              <td>{{ log.target_id }}</td>
              <td>
                {% if log.changes %}
                  <div class="changes-json">{{ log.changes }}</div>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
            </tr>
          {% else %}
            <tr>
              <td colspan="7" class="text-center">No logs found.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center">
        {% if pagination.has_prev %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('main.logs', page=pagination.prev_num) }}" aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>
        {% else %}
          <li class="page-item disabled">
            <span class="page-link">&laquo;</span>
          </li>
        {% endif %}

        {% for p in pagination.iter_pages() %}
          {% if p %}
            {% if p == pagination.page %}
              <li class="page-item active"><span class="page-link">{{ p }}</span></li>
            {% else %}
              <li class="page-item"><a class="page-link" href="{{ url_for('main.logs', page=p) }}">{{ p }}</a></li>
            {% endif %}
          {% else %}
            <li class="page-item disabled"><span class="page-link">â€¦</span></li>
          {% endif %}
        {% endfor %}

        {% if pagination.has_next %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('main.logs', page=pagination.next_num) }}" aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
        {% else %}
          <li class="page-item disabled">
            <span class="page-link">&raquo;</span>
          </li>
        {% endif %}
      </ul>
    </nav>
  </div>
{% endblock %}
