{% extends 'base.html' %}

{% block title %}
  Logs de Auditoria
{% endblock %}

{% block head_links %}
  <style>
    .changes-json {
      font-family: monospace;
      white-space: pre-wrap;
      font-size: 0.9em;
      max-height: 200px;
      overflow-y: auto;
    }
    .table-responsive {
      margin-top: 20px;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="container mt-4">
    <h1>Logs de Auditoria</h1>

    <!-- Filter Form -->
    <div class="card mb-4">
      <div class="card-body">
        <form method="GET" action="{{ url_for('main.audit_logs') }}" class="row g-3">
          <div class="col-md-2">
            <label for="action" class="form-label">Ação</label>
            <input type="text" class="form-control" id="action" name="action" value="{{ action_filter }}" placeholder="Ex: UPDATE" />
          </div>
          <div class="col-md-2">
            <label for="target_type" class="form-label">Tipo Alvo</label>
            <input type="text" class="form-control" id="target_type" name="target_type" value="{{ target_type_filter }}" placeholder="Ex: User" />
          </div>
          <div class="col-md-2">
            <label for="user_id" class="form-label">ID Usuário</label>
            <input type="number" class="form-control" id="user_id" name="user_id" value="{{ user_id_filter }}" placeholder="ID" />
          </div>
          <div class="col-md-2">
            <label for="start_date" class="form-label">Data Início</label>
            <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date }}" />
          </div>
          <div class="col-md-2">
            <label for="end_date" class="form-label">Data Fim</label>
            <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date }}" />
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">Filtrar</button>
            <a href="{{ url_for('main.audit_logs') }}" class="btn btn-secondary w-100 ms-2">Limpar</a>
          </div>
        </form>
      </div>
    </div>

    <!-- Logs Table -->
    <div class="table-responsive">
      <table class="table table-striped table-hover table-bordered">
        <thead class="table-dark">
          <tr>
            <th scope="col" style="width: 5%">ID</th>
            <th scope="col" style="width: 15%">Data/Hora</th>
            <th scope="col" style="width: 10%">Usuário (ID)</th>
            <th scope="col" style="width: 15%">Usuário (Código)</th>
            <th scope="col" style="width: 10%">Ação</th>
            <th scope="col" style="width: 10%">Tipo Alvo</th>
            <th scope="col" style="width: 10%">ID Alvo</th>
            <th scope="col" style="width: 25%">Alterações</th>
          </tr>
        </thead>
        <tbody>
          {% for log in logs %}
            <tr>
              <td>{{ log.id }}</td>
              <td>{{ log.timestamp.strftime('%d/%m/%Y %H:%M:%S') }}</td>
              <td>
                {% if log.user_id %}
                  {{ log.user_id }}
                {% else %}
                  System
                {% endif %}
              </td>
              <td>
                {% if log.user %}
                  {{ log.user.identificationCode }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                <span class="badge bg-secondary">{{ log.action }}</span>
              </td>
              <td>{{ log.target_type }}</td>
              <td>{{ log.target_id }}</td>

              <td>
                {% if log.changes %}
                  <div class="changes-json">{{ log.changes }}</div>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
            </tr>
          {% else %}
            <tr>
              <td colspan="8" class="text-center">Nenhum log encontrado.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <nav aria-label="Navegação de página">
      <ul class="pagination justify-content-center">
        {% if pagination.has_prev %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('main.audit_logs', page=pagination.prev_num, action=action_filter, target_type=target_type_filter, user_id=user_id_filter, start_date=start_date, end_date=end_date) }}" aria-label="Anterior"><span aria-hidden="true">&laquo;</span></a>
          </li>
        {% else %}
          <li class="page-item disabled">
            <span class="page-link">&laquo;</span>
          </li>
        {% endif %}

        {% for p in pagination.iter_pages() %}
          {% if p %}
            {% if p == pagination.page %}
              <li class="page-item active">
                <span class="page-link">{{ p }}</span>
              </li>
            {% else %}
              <li class="page-item">
                <a class="page-link" href="{{ url_for('main.audit_logs', page=p, action=action_filter, target_type=target_type_filter, user_id=user_id_filter, start_date=start_date, end_date=end_date) }}">{{ p }}</a>
              </li>
            {% endif %}
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">…</span>
            </li>
          {% endif %}
        {% endfor %}

        {% if pagination.has_next %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('main.audit_logs', page=pagination.next_num, action=action_filter, target_type=target_type_filter, user_id=user_id_filter, start_date=start_date, end_date=end_date) }}" aria-label="Próximo"><span aria-hidden="true">&raquo;</span></a>
          </li>
        {% else %}
          <li class="page-item disabled">
            <span class="page-link">&raquo;</span>
          </li>
        {% endif %}
      </ul>
    </nav>
  </div>
{% endblock %}
