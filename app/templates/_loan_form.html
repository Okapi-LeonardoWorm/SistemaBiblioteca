<form id="loanModalForm" action="{{ url_for('main.novo_emprestimo') if not loan_id else url_for('main.editar_emprestimo', loan_id=loan_id) }}" method="POST">
    {{ form.hidden_tag() }}
    <div class="row">
        <div class="col-md-6 mb-3">
            {{ form.loanDate.label(class="form-label") }}
            {{ form.loanDate(class="form-control", type="date") }}
        </div>
        <div class="col-md-6 mb-3">
            {{ form.returnDate.label(class="form-label") }}
            {{ form.returnDate(class="form-control", type="date") }}
        </div>
    </div>
    <div class="small text-muted mb-2">Preencha o período primeiro para habilitar a seleção de usuário, livro e quantidade.</div>

    <div class="row">
        <div class="col-md-6 mb-3">
            <label class="form-label">Usuário (buscar por nome ou código)</label>
            <input type="text" id="userSearch" class="form-control" placeholder="Digite ao menos 2 letras" autocomplete="off">
            {{ form.userId(type="hidden", id="selectedUserId") }}
            <div id="userSuggestions" class="list-group mt-1"></div>
            <div id="selectedUserInfo" class="small text-muted mt-2" style="display:none">
                <div><strong>Código:</strong> <span data-field="identificationCode"></span></div>
                <div><strong>Nome:</strong> <span data-field="name"></span></div>
                <div><strong>Idade:</strong> <span data-field="age"></span></div>
                <div><strong>Data Nasc.:</strong> <span data-field="birthDate"></span></div>
                <div><strong>Série/Turma:</strong> <span data-field="gradeNumber"></span> / <span data-field="className"></span></div>
                <div><strong>CPF/RG:</strong> <span data-field="cpf"></span> / <span data-field="rg"></span></div>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <label class="form-label">Livro (buscar por nome/autor/editora)</label>
            <input type="text" id="bookSearch" class="form-control" placeholder="Digite ao menos 2 letras" autocomplete="off">
            {{ form.bookId(type="hidden", id="selectedBookId") }}
            <div id="bookSuggestions" class="list-group mt-1"></div>
            <div id="selectedBookInfo" class="small text-muted mt-2" style="display:none">
                <div><strong>Nome:</strong> <span data-field="bookName"></span></div>
                <div><strong>Autor/Editora:</strong> <span data-field="authorName"></span> / <span data-field="publisherName"></span></div>
                <div><strong>Publicado:</strong> <span data-field="publishedDate"></span></div>
                <div><strong>Disponíveis no período:</strong> <span data-field="available"></span> / <span data-field="amount"></span></div>
                <div><strong>Palavras-chave:</strong> <span data-field="keywords"></span></div>
            </div>
        </div>
    </div>
    <div class="mb-3">
        {{ form.amount.label(class="form-label") }}
        {{ form.amount(class="form-control", type="number") }}
    </div>
    <div class="alert alert-danger d-none" id="loanFormError"></div>
</form>
<script>
(function() {
    const userSearch = document.getElementById('userSearch');
    const userSug = document.getElementById('userSuggestions');
    const userInfo = document.getElementById('selectedUserInfo');
    const hiddenUserId = document.getElementById('selectedUserId');

    const bookSearch = document.getElementById('bookSearch');
    const bookSug = document.getElementById('bookSuggestions');
    const bookInfo = document.getElementById('selectedBookInfo');
    const hiddenBookId = document.getElementById('selectedBookId');

    const loanDate = document.getElementById('loanDate') || document.querySelector('input[name="loanDate"]');
    const returnDate = document.getElementById('returnDate') || document.querySelector('input[name="returnDate"]');
    const amountInput = document.querySelector('input[name="amount"]');
    const errBox = document.getElementById('loanFormError');
    const isEditMode = {{ 'true' if loan_id else 'false' }};

    function datesReady() {
        return Boolean(loanDate?.value && returnDate?.value);
    }

    function toggleDependentFields() {
        if (isEditMode) return;
        const enabled = datesReady();
        if (userSearch) userSearch.disabled = !enabled;
        if (bookSearch) bookSearch.disabled = !enabled;
        if (amountInput) amountInput.disabled = !enabled;
        if (!enabled) {
            if (userSug) userSug.innerHTML = '';
            if (bookSug) bookSug.innerHTML = '';
        }
    }

    function setInfo(container, data) {
        if (!container) return;
        container.style.display = '';
        for (const [k, v] of Object.entries(data)) {
            const el = container.querySelector(`[data-field="${k}"]`);
            if (el) el.textContent = Array.isArray(v) ? v.join(', ') : (v ?? '');
        }
    }

    async function fetchJSON(url) {
        const r = await fetch(url);
        if (!r.ok) throw new Error('Erro ao buscar dados');
        return await r.json();
    }

    async function searchUsers(q) {
        if (!datesReady()) { userSug.innerHTML = ''; return; }
        if (!q || q.length < 2) { userSug.innerHTML = ''; return; }
        const data = await fetchJSON(`/api/users/search?q=${encodeURIComponent(q)}&limit=8`);
        userSug.innerHTML = '';

        function userTypeLabel(t) {
            const map = {
                student: 'Aluno',
                visitor: 'Visitante',
                staff: 'Funcionário',
                admin: 'Administrador',
                aluno: 'Aluno',
                colaborador: 'Colaborador',
                bibliotecario: 'Bibliotecário'
            };
            return map[t] || (t || '—');
        }

        (data.results || []).forEach(u => {
            const a = document.createElement('a');
            a.href = '#'; a.className = 'list-group-item list-group-item-action';
            a.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <strong>${u.name || 'Sem nome'}</strong>
                    <span class="badge text-bg-light border">${u.identificationCode || '—'}</span>
                </div>
                <div class="small text-muted mt-1 d-flex flex-wrap gap-3">
                    <span><strong>Tipo:</strong> ${userTypeLabel(u.userType)}</span>
                    <span><strong>Idade:</strong> ${u.age ?? '—'}</span>
                    <span><strong>Série/Turma:</strong> ${(u.gradeNumber ?? '—')} / ${(u.className ?? '—')}</span>
                </div>
            `;
            a.addEventListener('click', (e) => {
                e.preventDefault();
                hiddenUserId.value = u.userId;
                setInfo(userInfo, u);
                userSug.innerHTML = '';
                userSearch.value = `${u.identificationCode || ''} - ${u.name || ''}`.trim();
            });
            userSug.appendChild(a);
        });
    }

    async function searchBooks(q) {
        if (!datesReady()) { bookSug.innerHTML = ''; return; }
        if (!q || q.length < 2) { bookSug.innerHTML = ''; return; }
        const params = new URLSearchParams({ q, limit: '8' });
        if (loanDate?.value) params.append('loanDate', loanDate.value);
        if (returnDate?.value) params.append('returnDate', returnDate.value);
        const data = await fetchJSON(`/api/books/search?${params.toString()}`);
        bookSug.innerHTML = '';

        function formatDateBR(isoDate) {
            if (!isoDate) return '—';
            const [y, m, d] = isoDate.split('-');
            if (!y || !m || !d) return isoDate;
            return `${d}/${m}/${y}`;
        }

        (data.results || []).forEach(b => {
            const a = document.createElement('a');
            a.href = '#'; a.className = 'list-group-item list-group-item-action';
            a.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <strong>${b.bookName || 'Sem título'}</strong>
                    <span class="badge text-bg-light border">Disponíveis: ${b.available ?? '—'} / ${b.amount ?? '—'}</span>
                </div>
                <div class="small text-muted mt-1 d-flex flex-wrap gap-3">
                    <span><strong>Autor:</strong> ${b.authorName || '—'}</span>
                    <span><strong>Publicação:</strong> ${formatDateBR(b.publishedDate)}</span>
                </div>
            `;
            a.addEventListener('click', (e) => {
                e.preventDefault();
                hiddenBookId.value = b.bookId;
                setInfo(bookInfo, b);
                bookSug.innerHTML = '';
                bookSearch.value = `${b.bookName}`;
            });
            bookSug.appendChild(a);
        });
    }

    userSearch?.addEventListener('input', (e) => searchUsers(e.target.value));
    bookSearch?.addEventListener('input', (e) => searchBooks(e.target.value));
    loanDate?.addEventListener('change', () => { toggleDependentFields(); bookSearch?.value && searchBooks(bookSearch.value); });
    returnDate?.addEventListener('change', () => { toggleDependentFields(); bookSearch?.value && searchBooks(bookSearch.value); });

    toggleDependentFields();
})();
</script>
